#!/usr/bin/env bash

#Author: @DawsonBotsford  |  dawsonbotsford.com
#Repo Location: https://github.com/dawsonbotsford/swim
#Date: 09-28-2015

VERSION="1.0.0"
usrDir=/usr/local/bin

function print_help() {
  echo "

Switch vimrc files without pain

Usage:
  swim add <URLToRaw or pathToFile>  <alias>   Add a swim alias
  swim with <alias>                            Change active vimrc file
  swim ls                                      List aliased vimrc files
  swim active                                  Show currently aliased vimrc
  swim rename <alias1> <alias2>                Rename alias (like Linux mv)
  swim delete <alias>                          Delete an alias entirely
  swim update                                  Download newest version
  swim version                                 Print version
  swim help                                    Show this message


Example:
  swim add github.com/dawsonbotsford/swim/exampleVimrcs/vimrcWikia.vim example
  swim ls                    Show available swim aliases
  swim with example          Set ~/.swim/.swimrc.example as primary .vimrc
  swim with main             Set ~/.swim/.swimrc.main as primary .vimrc


Setup:
  On install, you will have the \"main\" swim alias. Add alternate vimrc aliases with \"swim add <URLToRaw or pathToFile>  <alias>\"
  Then use \"swim with <alias\" to change your active vimrc file.


Report bugs to: https://github.com/dawsonbotsford/swim/issues

Uninstall:
    swim uninstall
"
}

function swim_ls() {
  for file in ~/.swim/*
  do
    echo $file | cut -d . -f 3
  done
}

function get_alias() {
  path = $1
  return head -n1 $path | cut -d \" -f 2 | cut -d \\ -f 2
}

function add_alias() {
  if [ $# -lt 2 ]
  then
    print_help
    exit
  fi
  src=$1
  dest=$2
  webRegex='(https?|ftp|file)://[-A-Za-z0-9\+&@#/%?=~_|!:,.;]*[-A-Za-z0-9\+&@#/%=~_|]'
  if [[ $1 =~ $webRegex ]]
  then
    echo "performing curl"
    curl -o ~/.swim/swimrc.$2 -s $1
  else
    cp $1 ~/.swim/swimrc.$2
  fi
  echo "swim alias \"$2\" added"
}

function mv_alias() {
  if [ $# -lt 2 ]
  then
    print_help
    exit
  fi
  src=$1
  dest=$2

  mv ~/.swim/swimrc.$1 ~/.swim/swimrc.$2

  #if trying to move active vimrc
  if [[ $(readlink ~/.vimrc | cut -d . -f 3) == $1 ]]; then
    echo "swimming with "$2
    ln -s ~/.swim/swimrc.$2 ~/.vimrc
  fi

  echo "swim alias \"$2\" added"
}

function remove_alias() {
  if [ $# -eq 0 ]; then
    print_help
    exit
  fi

  activeFile=$(readlink ~/.vimrc)
  activeAlias=$file | cut -d \. -f 3

  rm ~/.swim/swimrc.$1
  echo "removed alias $1"
}

function backup_vimrc (){
  if [ -a "~/.vimrc" ]; then
    mkdir -p ~/.swim/oldvimrc
    # mv $(readlink ~/.vimrc) ~/.swim/oldvimrc
    mv ~/.vimrc ~/.swim/oldvimrc
  fi
}

#Help conditions
if [ $# -lt 1 ]; then
  print_help
  exit
fi

while [ $# -gt 0 ]; do
  case "$1" in
    uninstall) curl -s https://raw.githubusercontent.com/dawsonbotsford/swim/master/uninstall | bash
      exit;;

    help | -h) print_help
      shift
      exit;;

    ls | show | -l) shift
      swim_ls
      exit;;

    add | new | -a) add_alias $2 $3
      exit;;

    rename | mv | move) mv_alias $2 $3
      exit;;

    active | current) file=$(readlink ~/.vimrc)
      if [ $file ]; then
        echo $file | cut -d \. -f 3
      else
        echo "Error. Swim may not be installed"
        exit
      fi
      shift;;

    with | use) shift
      if [ -e "$HOME/.swim/swimrc.$1" ]; then
        if [[ $(readlink ~/.vimrc | cut -d . -f 3) == $1 ]]; then
          echo "that swimrc is already active."
          exit
        fi
        backup_vimrc
        rm ~/.vimrc
        ln -s ~/.swim/swimrc.$1 ~/.vimrc
        echo "swimming with "$1
      else
        echo "alias $1 not found"
        sleep 1
        print_help
      fi
      shift;;

    remove | delete) remove_alias $2
                     exit;;

    update | install) printf "Old version: " && swim version | chalk bold red
      printf "Downloading from Github.com/dawsonbotsford/swim...\n"
      curl -o $usrDir/swim -s https://raw.githubusercontent.com/dawsonbotsford/swim/master/swim
      chmod +x $usrDir/swim
      printf "New version: " && swim version | chalk green
      exit;;

    version | -v | -V) echo $VERSION
      exit;;

    *) print_help
      exit;;
  esac
done
